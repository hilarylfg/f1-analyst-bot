import { logger } from '../../utils/logger.js'
import { askAI } from '../ai/open-router.js'
import { contextBuilder } from '../stats/context-builder.js'

export async function analyzeDriverComparison(
	driver1: string,
	driver2: string,
	openRouterKey: string
): Promise<string> {
	try {
		const context = contextBuilder.getDriverComparisonContext(
			driver1,
			driver2
		)

		if (context.startsWith('–û–®–ò–ë–ö–ê:')) {
			return context
		}

		const prompt = createComparisonPrompt(context)

		return await askAI(prompt, openRouterKey, false)
	} catch (error) {
		logger.error('–û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–∏–ª–æ—Ç–æ–≤', error)
		throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∏–ª–æ—Ç–æ–≤')
	}
}

function createComparisonPrompt(context: string): string {
	const currentDate = new Date().toISOString().split('T')[0]

	return `
–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: ${currentDate}

${context}

**–ó–ê–î–ê–ß–ê:** –ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∏–ª–æ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–• –≤—ã—à–µ.

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º

**–°–¢–†–£–ö–¢–£–†–ê –ê–ù–ê–õ–ò–ó–ê:**

**üèÜ –¢–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ**
–ö—Ç–æ –≤–ø–µ—Ä–µ–¥–∏ –∏ –ø–æ—á–µ–º—É? –°—Ä–∞–≤–Ω–∏ –æ—á–∫–∏, –ø–æ–±–µ–¥—ã, –ø–æ–¥–∏—É–º—ã.

**üìà –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ —Ñ–æ—Ä–º–∞**
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –≥–æ–Ω–æ–∫ –∫–∞–∂–¥–æ–≥–æ. –ö—Ç–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ?

**üí™ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã**
–í —á—ë–º –∫–∞–∂–¥—ã–π –ø–∏–ª–æ—Ç —Ö–æ—Ä–æ—à? (–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è, –≥–æ–Ω–∫–∞, –æ–±–≥–æ–Ω—ã, —Ç–∞–∫—Ç–∏–∫–∞)

**‚öñÔ∏è –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è**
–ß—Ç–æ –≤—ã–¥–µ–ª—è–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–∑ –Ω–∏—Ö? –ö–æ–º–∞–Ω–¥–∞? –û–ø—ã—Ç? –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å?

**üéØ –ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥**
–ö—Ç–æ –∏–º–µ–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –≤ —ç—Ç–æ–º —Å–µ–∑–æ–Ω–µ –∏ –ø–æ—á–µ–º—É?

**–¢–†–ï–ë–û–í–ê–ù–ò–Ø:**
- –ú–∞–∫—Å–∏–º—É–º 3500 —Å–∏–º–≤–æ–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π Markdown (–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–∫–∏)
- –ë–ï–ó –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —É—Ä–æ–≤–Ω—è # (—Ç–æ–ª—å–∫–æ **)
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
`
}
