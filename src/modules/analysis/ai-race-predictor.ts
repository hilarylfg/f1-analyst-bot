import { askAI } from "../ai/open-router.js";
import { contextBuilder } from '../stats/context-builder.js';

interface PredictionResult {
    driver: string;
    team: string;
    predictedPosition: number;
    podiumProbability: number;
    winProbability: number;
    reasoning: string;
}

const currentDate = new Date();

export class AIRacePredictor {
    private openRouterKey: string;

    constructor(openRouterKey: string) {
        this.openRouterKey = openRouterKey;
    }

    async predictRaceResults(trackName: string): Promise<{ predictions: PredictionResult[]; analysis: string }> {
        try {
            const seasonContext = contextBuilder.getChampionshipContext();
            const prediction = await this.generateRacePrediction(seasonContext, trackName);

            const analysis = (prediction.analysis || '').trim();
            if (!analysis) {
                const fallback = `–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /ask –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.`;
                console.warn('AI returned empty analysis for /predict', { trackName });
                return { predictions: prediction.predictions || [], analysis: fallback };
            }

            return prediction;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–∏–∫—Ü–∏–∏:', error);
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–¥–∏–∫—Ü–∏—é –¥–ª—è –≥–æ–Ω–∫–∏');
        }
    }

    private async generateRacePrediction(seasonContext: string, trackName: string): Promise<{
        predictions: PredictionResult[];
        analysis: string
    }> {
        const prompt = `
${seasonContext}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**–ó–ê–î–ê–ß–ê:** –°–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–µ–¥–∏–∫—Ü–∏—é –≥–æ–Ω–∫–∏ –Ω–∞ —Ç—Ä–∞—Å—Å–µ **${trackName}**

**–®–ê–ì 1: –ê–ù–ê–õ–ò–ó –î–ê–ù–ù–´–•**
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã—à–µ:
- –ö—Ç–æ –ª–∏–¥–∏—Ä—É–µ—Ç –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ –∏ –ø–æ—á–µ–º—É?
- –ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ?
- –ö—Ç–æ –≤ —Ñ–æ—Ä–º–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–Ω–∫–∏)?
- –ö—Ç–æ –±–æ—Ä–µ—Ç—Å—è –∑–∞ –ø–æ–¥–∏—É–º?

**–®–ê–ì 2: –û–°–û–ë–ï–ù–ù–û–°–¢–ò –¢–†–ê–°–°–´**
–í—Å–ø–æ–º–Ω–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç—Ä–∞—Å—Å—ã ${trackName}:
- –¢–∏–ø —Ç—Ä–∞—Å—Å—ã (—Å–∫–æ—Ä–æ—Å—Ç–Ω–∞—è/—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è/—É–ª–∏—á–Ω–∞—è/—Å–º–µ—à–∞–Ω–Ω–∞—è)
- –ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã/–ø–∏–ª–æ—Ç—ã –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ —Å–∏–ª—å–Ω—ã –∑–¥–µ—Å—å?
- –ö–ª—é—á–µ–≤—ã–µ –ø–æ–≤–æ—Ä–æ—Ç—ã –∏ –∑–æ–Ω—ã –æ–±–≥–æ–Ω–∞

**–®–ê–ì 3: –°–û–ó–î–ê–ô –ü–†–ï–î–ò–ö–¶–ò–Æ**

–ù–∞–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–ª–∞–Ω—É:

**üèÜ –§–ê–í–û–†–ò–¢–´ –ù–ê –ü–û–ë–ï–î–£** (2-3 –ø–∏–ª–æ—Ç–∞)
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∫–∞–∂–∏:
- –ü–æ—á–µ–º—É –æ–Ω —Ñ–∞–≤–æ—Ä–∏—Ç (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö)
- –ï–≥–æ —Ñ–æ—Ä–º–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3-5 –≥–æ–Ω–æ–∫)
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞ —ç—Ç–æ–π —Ç—Ä–∞—Å—Å–µ
–ü—Ä–∏–º–µ—Ä: *"–û—Å–∫–∞—Ä –ü–∏–∞—Å—Ç—Ä–∏ (McLaren) ‚Äî –ª–∏–¥–µ—Ä —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞ —Å 5 –ø–æ–±–µ–¥–∞–º–∏ –∏ 150 –æ—á–∫–∞–º–∏. –í—ã–∏–≥—Ä–∞–ª 3 –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –≥–æ–Ω–æ–∫, –≤–∫–ª—é—á–∞—è –ú–æ–Ω–∞–∫–æ ‚Äî —Å—Ö–æ–∂—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Ç—Ä–∞—Å—Å—É. McLaren –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç –≤ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –ø–æ–≤–æ—Ä–æ—Ç–∞—Ö."*

**ü•á –ü–û–î–ò–£–ú: –¢–û–ü-5 –ü–ò–õ–û–¢–û–í** (—Å –∫—Ä–∞—Ç–∫–∏–º –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º)
1. [–ü–∏–ª–æ—Ç] ‚Äî [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ—á–µ–º—É]
2. [–ü–∏–ª–æ—Ç] ‚Äî [1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ—á–µ–º—É]

...

**ü¶Ñ –¢–Å–ú–ù–ê–Ø –õ–û–®–ê–î–ö–ê** (1 –ø–∏–ª–æ—Ç)
–ö—Ç–æ –º–æ–∂–µ—Ç —É–¥–∏–≤–∏—Ç—å –∏ –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–æ–ø-5? –û–±–æ—Å–Ω—É–π –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –ü–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —Ç—Ä–∞—Å—Å—ã
- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Å—é—Ä–ø—Ä–∏–∑–æ–≤

**üîë –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ö–¢–û–†–´**
3-5 –ø—É–Ω–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞—Ç –∏—Å—Ö–æ–¥ –≥–æ–Ω–∫–∏:
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–∏—Ç-—Å—Ç–æ–ø–æ–≤
- –ü–æ–≥–æ–¥–∞ (–µ—Å–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ)
- –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è
- –û–±–≥–æ–Ω—ã / –∑–∞—â–∏—Ç–∞ –ø–æ–∑–∏—Ü–∏–π
- –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –±–æ–ª–∏–¥–æ–≤

**üìä –ò–¢–û–ì–û–í–´–ô –ü–†–û–ì–ù–û–ó –ü–û–î–ò–£–ú–ê:**
1. [–ü–∏–ª–æ—Ç] (–ö–æ–º–∞–Ω–¥–∞)
2. [–ü–∏–ª–æ—Ç] (–ö–æ–º–∞–Ω–¥–∞)  
3. [–ü–∏–ª–æ—Ç] (–ö–æ–º–∞–Ω–¥–∞)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

**–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï:**
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤—ã—à–µ
- –ë—É–¥—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º, –Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º
- –ó–∞–∫–æ–Ω—á–∏ –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –∑–∞–∫–æ–Ω—á–∏ –æ—Ç–≤–µ—Ç –ò—Ç–æ–≥–æ–≤—ã–º –ø—Ä–æ–≥–Ω–æ–∑–æ–º –ø–æ–¥–∏—É–º–∞
`;

        const analysis = await askAI(prompt, this.openRouterKey);

        return {
            predictions: [],
            analysis
        };
    }
}